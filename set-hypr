#!/usr/bin/env bash
set -Eeuo pipefail

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LOG_FILE="${REPO_ROOT}/install.log"

NON_INTERACTIVE=false
AUTO_YES=false
DRY_RUN=false
STRICT_MODE=false

AUR_HELPER_PREF="auto"
GROUPS_CSV="core"
ENABLE_SERVICES_CSV=""

INSTALL_PACKAGES=true
WITH_NVIDIA="ask"
APPLY_CONFIG="ask"
DISABLE_WIFI_POWERSAVE="ask"
APPLY_SDDM_THEME="ask"
REMOVE_CONFLICTING_PORTALS="ask"
INSTALL_TOGGLE="ask"
INSTALL_WLOGOUT_ICONS="ask"
ADD_INPUT_GROUP="ask"
ACTIVATE_STARSHIP="ask"
START_SDDM_NOW="ask"
INSTALL_HYPR_PLUGINS="ask"

usage() {
    cat <<USAGE
Usage: ./set-hypr [options]

Options:
  --non-interactive                Disable prompts; only explicit action flags run risky tasks.
  --yes                            Auto-confirm prompts.
  --dry-run                        Print commands without executing.
  --strict                         Missing optional config sources become fatal.
  --log-file PATH                  Log file path (default: ${REPO_ROOT}/install.log).

  --aur-helper auto|yay|paru       Select AUR helper (default: auto).
  --groups core,theme,apps         Package groups to install (default: core).
  --skip-packages                  Skip package installation stage.

  --with-nvidia                    Install/configure NVIDIA support.
  --without-nvidia                 Skip NVIDIA support.
  --disable-wifi-powersave         Disable WiFi powersave via NetworkManager config.
  --apply-config                   Deploy HyprV config into ~/.config.
  --apply-sddm-theme               Install and activate bundled SDDM theme.
  --remove-conflicting-portals     Remove xdg-desktop-portal-gnome/gtk if installed.
  --install-toggle                 Install toggle helper to /usr/local/bin.
  --install-wlogout-icons          Copy wlogout icons to /etc/wlogout-icon.
  --add-input-group                Add current user to input group.
  --activate-starship              Copy starship.toml and init line in ~/.bashrc.
  --enable-service LIST            Comma list: bluetooth,sddm.
  --start-sddm-now                 Start sddm.service at end.
  --install-hypr-plugins           Install Hyprland plugins using hyprpm.
  --skip-hypr-plugins              Skip Hyprland plugin installation.

  -h, --help                       Show this help.
USAGE
}

append_csv() {
    local current="$1"
    local addition="$2"
    if [[ -z "$current" ]]; then
        echo "$addition"
    else
        echo "${current},${addition}"
    fi
}

parse_args() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --non-interactive)
                NON_INTERACTIVE=true
                ;;
            --yes)
                AUTO_YES=true
                ;;
            --dry-run)
                DRY_RUN=true
                ;;
            --strict)
                STRICT_MODE=true
                ;;
            --log-file)
                shift
                [[ $# -gt 0 ]] || { echo "Missing value for --log-file" >&2; exit 1; }
                LOG_FILE="$1"
                ;;
            --aur-helper)
                shift
                [[ $# -gt 0 ]] || { echo "Missing value for --aur-helper" >&2; exit 1; }
                AUR_HELPER_PREF="$1"
                ;;
            --groups)
                shift
                [[ $# -gt 0 ]] || { echo "Missing value for --groups" >&2; exit 1; }
                GROUPS_CSV="$1"
                ;;
            --skip-packages)
                INSTALL_PACKAGES=false
                ;;
            --with-nvidia)
                WITH_NVIDIA=true
                ;;
            --without-nvidia)
                WITH_NVIDIA=false
                ;;
            --disable-wifi-powersave)
                DISABLE_WIFI_POWERSAVE=true
                ;;
            --apply-config)
                APPLY_CONFIG=true
                ;;
            --apply-sddm-theme)
                APPLY_SDDM_THEME=true
                ;;
            --remove-conflicting-portals)
                REMOVE_CONFLICTING_PORTALS=true
                ;;
            --install-toggle)
                INSTALL_TOGGLE=true
                ;;
            --install-wlogout-icons)
                INSTALL_WLOGOUT_ICONS=true
                ;;
            --add-input-group)
                ADD_INPUT_GROUP=true
                ;;
            --activate-starship)
                ACTIVATE_STARSHIP=true
                ;;
            --enable-service)
                shift
                [[ $# -gt 0 ]] || { echo "Missing value for --enable-service" >&2; exit 1; }
                ENABLE_SERVICES_CSV="$(append_csv "$ENABLE_SERVICES_CSV" "$1")"
                ;;
            --start-sddm-now)
                START_SDDM_NOW=true
                ;;
            --install-hypr-plugins)
                INSTALL_HYPR_PLUGINS=true
                ;;
            --skip-hypr-plugins)
                INSTALL_HYPR_PLUGINS=false
                ;;
            -h|--help)
                usage
                exit 0
                ;;
            *)
                echo "Unknown option: $1" >&2
                usage
                exit 1
                ;;
        esac
        shift
    done
}

parse_args "$@"

# shellcheck source=lib/common.sh
source "$REPO_ROOT/lib/common.sh"
# shellcheck source=lib/pkg.sh
source "$REPO_ROOT/lib/pkg.sh"
# shellcheck source=lib/config.sh
source "$REPO_ROOT/lib/config.sh"
# shellcheck source=lib/system.sh
source "$REPO_ROOT/lib/system.sh"

trap 'on_error "$LINENO" "$BASH_COMMAND"' ERR

confirm_action() {
    local current="$1"
    local prompt="$2"
    local default_answer="${3:-n}"

    case "$current" in
        true)
            return 0
            ;;
        false)
            return 1
            ;;
        ask)
            confirm "$prompt" "$default_answer"
            return $?
            ;;
        *)
            die "Invalid action value: $current" 1
            ;;
    esac
}

confirm_risky_action() {
    local current="$1"
    local prompt="$2"

    case "$current" in
        true)
            return 0
            ;;
        false)
            return 1
            ;;
        ask)
            if [[ "$NON_INTERACTIVE" == "true" ]]; then
                return 1
            fi
            confirm "$prompt" "n"
            return $?
            ;;
        *)
            die "Invalid risky action value: $current" 1
            ;;
    esac
}

validate_groups() {
    local raw="$1"
    local group
    split_csv "$raw"

    if [[ ${#SPLIT_RESULT[@]} -eq 0 ]]; then
        die "No package groups specified" 1
    fi

    for group in "${SPLIT_RESULT[@]}"; do
        group="$(trim_whitespace "$group")"
        case "$group" in
            core|theme|apps)
                ;;
            *)
                die "Unknown package group: $group" 1
                ;;
        esac
    done
}

preflight() {
    [[ $EUID -ne 0 ]] || die "Do not run this script as root; run as your user." 2

    command_exists pacman || die "pacman not found; this script targets Arch Linux." 2
    command_exists sudo || die "sudo not found." 2

    [[ -d "$REPO_ROOT/HyprV" ]] || die "Missing HyprV directory in repository." 2
    [[ -d "$REPO_ROOT/Extras" ]] || die "Missing Extras directory in repository." 2

    validate_groups "$GROUPS_CSV"
}

run_package_stage() {
    local group
    local list_file

    split_csv "$GROUPS_CSV"
    for group in "${SPLIT_RESULT[@]}"; do
        group="$(trim_whitespace "$group")"
        list_file="$REPO_ROOT/packages/${group}.txt"
        log_note "Installing package group: $group"
        install_packages_from_file "$list_file" || die "Package stage failed for group: $group" 3
    done
}

collect_service_choices() {
    if [[ -n "$ENABLE_SERVICES_CSV" ]]; then
        return
    fi

    if [[ "$NON_INTERACTIVE" == "true" ]]; then
        return
    fi

    if confirm "Enable bluetooth service?" "n"; then
        ENABLE_SERVICES_CSV="$(append_csv "$ENABLE_SERVICES_CSV" "bluetooth")"
    fi

    if confirm "Enable sddm service?" "n"; then
        ENABLE_SERVICES_CSV="$(append_csv "$ENABLE_SERVICES_CSV" "sddm")"
    fi
}

main() {
    init_logging
    preflight

    log_note "Repository root: $REPO_ROOT"
    log_note "Log file: $LOG_FILE"

    if [[ "$DRY_RUN" == "false" ]]; then
        sudo_ready
    fi

    if [[ "$INSTALL_PACKAGES" == "true" || "$WITH_NVIDIA" != "false" ]]; then
        detect_aur_helper "$AUR_HELPER_PREF"
    fi

    if [[ "$INSTALL_PACKAGES" == "true" ]]; then
        if confirm_action "ask" "Install package groups: $GROUPS_CSV ?" "y"; then
            run_package_stage
        else
            log_warn "Skipping package installation stage by user choice"
        fi
    else
        log_note "Package stage skipped via --skip-packages"
    fi

    if confirm_risky_action "$WITH_NVIDIA" "Install and configure NVIDIA support?"; then
        configure_nvidia "$REPO_ROOT/packages/nvidia.txt" || die "NVIDIA setup failed" 5
    fi

    if confirm_action "$APPLY_CONFIG" "Deploy HyprV config files to ~/.config?" "y"; then
        deploy_hyprv_config "$REPO_ROOT" || die "Config deploy failed" 4
    fi

    if confirm_action "$ACTIVATE_STARSHIP" "Apply starship config and shell init line?" "n"; then
        apply_starship_config "$REPO_ROOT" || die "Starship config step failed" 4
    fi

    if confirm_action "$INSTALL_HYPR_PLUGINS" "Install Hyprland plugins via hyprpm (hycov, hyprland-plugins, hyprgrass)?" "n"; then
        install_hypr_plugins || die "Hyprland plugin installation failed" 4
    fi

    if confirm_risky_action "$DISABLE_WIFI_POWERSAVE" "Disable WiFi powersave (NetworkManager)?"; then
        disable_wifi_powersave || die "Failed disabling WiFi powersave" 5
    fi

    if confirm_risky_action "$INSTALL_TOGGLE" "Install toggle helper to /usr/local/bin?"; then
        install_toggle_binary "$REPO_ROOT" || die "Failed installing toggle helper" 5
    fi

    if confirm_risky_action "$INSTALL_WLOGOUT_ICONS" "Install wlogout icons to /etc/wlogout-icon?"; then
        install_wlogout_icons || die "Failed installing wlogout icons" 5
    fi

    if confirm_risky_action "$ADD_INPUT_GROUP" "Add current user to group 'input'?"; then
        add_user_to_input_group || die "Failed adding user to input group" 5
    fi

    if confirm_risky_action "$APPLY_SDDM_THEME" "Install and activate bundled SDDM theme?"; then
        apply_sddm_theme "$REPO_ROOT" || die "Failed applying SDDM theme" 5
    fi

    if confirm_risky_action "$REMOVE_CONFLICTING_PORTALS" "Remove xdg-desktop-portal-gnome/gtk?"; then
        remove_conflicting_portals || die "Failed removing conflicting portals" 5
    fi

    collect_service_choices
    if [[ -n "$ENABLE_SERVICES_CSV" ]]; then
        enable_service_list "$ENABLE_SERVICES_CSV" || die "Failed enabling one or more services" 5
    fi

    if confirm_risky_action "$START_SDDM_NOW" "Start sddm.service now?"; then
        run_sudo_cmd "Starting sddm.service" systemctl start sddm.service || die "Failed to start sddm.service" 5
    fi

    log_ok "Completed successfully."
    log_note "Re-run is safe; existing config/state is backed up when replaced."
    log_note "Log saved at: $LOG_FILE"
}

main "$@"
